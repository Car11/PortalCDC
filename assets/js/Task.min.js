function BtnCreateNew(){id="NULL",$("#row-comments").hide(),$("#ModalLabel").text("Ingresar Nueva Tarea"),$.ajax({type:"POST",url:"class/Task.php",data:{action:"serverDatetime"}}).done(function(e){var a=e.slice(0,16);document.getElementById("date_started").value=a,document.getElementById("date_due").value=""}).fail(function(){var e=new Date(Date()+"GMT-0000"),a=e.toISOString().slice(0,16);document.getElementById("date_started").value=a,document.getElementById("date_due").value=""})}function LoadColumns(){$.ajax({type:"POST",url:"class/Task.php",data:{action:"LoadColumns"}}).done(function(e){ShowColumn(e)})}function ShowColumn(e){$("#drag-list").html("");var a=JSON.parse(e),t="",n="",i="";$.each(a,function(e,a){switch(a.position){case"1":t="drag-column-on-hold",n='<button type="button" style="background-color: transparent; border: 0;" id="btn-create-new-task" onclick="BtnCreateNew()" data-toggle="modal" data-target=".bd-example-modal-lg"> <span class="fa fa-plus-circle" aria-hidden="true" </span></button>';break;case"2":t="drag-column-in-progress",n="",i="";break;case"3":t="drag-column-needs-review",n="",i="";break;case"4":t="drag-column-approved",n="",i="";break;default:t="drag-column-on-hold",n="",i=""}var o='<li class="drag-column '+t+'"><span class="drag-column-header"><h2 style="color: white; font-family: Lato; font-size: 1.3rem; margin: 0; text-transform: uppercase; font-weight: 150; line-height: 1.5; -webkit-font-smoothing: antialiased;">'+a.title+"</h2>"+i+n+'</span><div class="drag-options" id="options7"></div><ul class="drag-inner-list" id="'+a.position+'"></ul></li>';$("#drag-list").append(o)}),LoadTasks()}function LoadTasks(){$.ajax({type:"POST",url:"class/Task.php",data:{action:"LoadTask"}}).done(function(e){ShowTasks(e)})}function LoadTaskByName(){$.ajax({type:"POST",url:"class/Task.php",data:{action:"LoadTaskByName"}}).done(function(e){ShowTasks(e)})}function ShowTasks(e){$("li.task").html("");var a=JSON.parse(e);$.each(a,function(e,a){var t=moment(1e3*a.date_started).format(),n=t.slice(0,16).replace("T"," "),i="#"+a.position,o='<li class="'+a.title+' task" onclick="open_task('+a.id+')" onmouseover="taskMouseOver(this)" onmouseout="taskMouseOut(this)"><p>No: '+a.id+"<br>Fecha: "+n+"<br>Asunto: "+a.title+"<br></p></li>";$(i).append(o)}),$("#buscar").val("")}function open_task(e){id=e,$.ajax({type:"POST",url:"class/Task.php",data:{action:"Load",id:e}}).done(function(e){ShowTaskData(e)}).fail(showError),$(".bd-example-modal-lg").modal("show")}function taskMouseOver(e){e.style.backgroundColor="#33363d",e.style.fontWeight="600",e.style.cursor="pointer"}function taskMouseOut(e){e.style.backgroundColor="#1e2026",e.style.fontWeight="400"}function encode_Files(){$("#inputFileToLoad").change(function(){arrayOffiles=[];var e=document.getElementById("inputFileToLoad").files;if(e.length>0)for(var a=0;a<document.getElementById("inputFileToLoad").files.length;a+=1)getBase64(e[a])})}function getBase64(e){arrayOfThisfile=[];var a=new FileReader;a.readAsDataURL(e),a.onload=function(a){arrayOfThisfile=[],$("dataExt",{src:a.target.result,title:e.name}),arrayOfThisfile.push(e.name),arrayOfThisfile.push(a.target.result),arrayOffiles.push(arrayOfThisfile)},a.onerror=function(e){console.log("Error: ",e)}}function downloadURI(e,a){var t=document.createElement("a");t.download=a,t.href=e,document.body.appendChild(t),t.click(),document.body.removeChild(t),delete t}function saveFile(e,a,t){if(null!=t&&navigator.msSaveBlob)return navigator.msSaveBlob(new Blob([t],{type:a}),e);var n=$("<a style='display: none;'/>"),i=window.URL.createObjectURL(new Blob([t],{type:a}));n.attr("href",i),n.attr("download",e),$("body").append(n),n[0].click(),window.URL.revokeObjectURL(i),n.remove()}function decode_file(e,a){var t=e.split('"'),n=t[1];n=n.replace(/\\/g,"");var i=n.substr(0,5);switch(i){case"iVBOR":n="data:image/png;base64,"+n;break;case"/9J/4":n="data:application/pdf;base64,"+n;break;case"AAAAF":n="data:video/mp4;base64,"+n;break;case"JVBER":n="data:application/pdf;base64,"+n;break;case"UEsDB":n="data:application/msword;base64,"+n;break;case"TVqQA":n="data:application/x-msdownload;base64,"+n;break;case"PGh0b":n="data:text/html;base64,"+n;break;case"/9j/4":n="data:image/jpg;base64,"+n;break;default:n="data:application/octet-stream,"+n}download(n,a)}function showInfo(){swal({position:"top-end",type:"success",title:"Good!",showConfirmButton:!1,timer:750})}function showError(e){var a=JSON.parse(e.responseText);swal({type:"error",title:"Oops...",text:"Algo no está bien ("+a.code+"): "+a.msg,footer:"<a href>Contacte a Soporte Técnico</a>"})}function Load(){$.ajax({type:"POST",url:"class/Task.php",data:{action:"LoadTasksByUser"}}).done(function(e){ShowData(e)}).fail(showError)}function ShowData(e){$("#task-tbody").html("");var a=JSON.parse(e);$.each(a,function(e,a){var t=new Date(1e3*a.date_started),n=t.toISOString().slice(0,16).replace("T"," "),i='<tr><td align="center"><a id=Update'+a.id+' class="btn btn-default"><em class="fa fa-pencil"></em></a><a id=Delete'+a.id+' class="btn btn-danger"><em class="fa fa-trash"></em></a></td><td class="hidden-xs">'+a.id+'</td><td style="min-width: 17em; max-width: 17em;">'+a.title+'</td><td style="min-width: 22em; max-width: 22em;">'+a.description+'</td><td style="min-width: 6em; max-width: 7em;">'+a.position+'</td><td style="min-width: 9em; max-width: 9em;">'+n+"</td></tr>";$("#task-tbody").append(i)})}function UpdateEventHandler(){$(".bd-example-modal-lg").css({display:"block"}),id=$(this).parents("tr").find("td").eq(1).text(),$.ajax({type:"POST",url:"class/Task.php",data:{action:"Load",id:id}}).done(function(e){ShowTaskData(e)}).fail(showError)}function CleanCtls(){$("#title").val(""),$("#description").val(""),$("#column_id").val(""),$("#owner_id").val(""),$("#newComment").val(""),$("#hascomments").hide(),arrayOffiles=[],arraySubTask=[],$("#dataTable").empty(),$("#dataTable").append('\n        <tr>\n            <td> <input id="chk" type="checkbox" name="chk"/> </td>\n            <td> <span style="color:#ddd;"> 1 </span> </td>\n            <td> <input id="subtask" class="sub-task-desc" type="text"/> </td>\n            <td> <label id="estado" name="estado" class="label label-primary"> Pendiente </label> </td>\n            <td  style="visibility: hidden"> <input id="idSubTask" name="idSubTask" value="new"/> </td>\n        </tr>\n    '),$("#commentBox").html(""),id="NULL"}function ShowTaskData(e){clearAttachments(),$("#newComment").removeAttr("disabled"),$("#row-comments").show(),$("#ModalLabel").text("Modificar Tarea");var a=JSON.parse(e);if($("#title").val(a[0].title),$("#description").val(a[0].description),a[0].date_started.length>2)var t=moment(1e3*a[0].date_started).format(),n=t.slice(0,16);if(a[0].date_due.length>2)var i=moment(1e3*a[0].date_due).format(),o=i.slice(0,16);$("#date_started").val(n),$("#date_due").val(o),LoadAttachments(),LoadSubTasksByTask(),comment.taskId=id,comment.LoadbyTask}function loadProjectsByUser(e){var a=JSON.parse(e);$.each(a,function(e,a){var t="<option value="+a.id+">"+a.name+"</option>";$(".list").append(t)})}function LoadProjects(){$.ajax({type:"POST",url:"class/Project.php",data:{action:"GetByUserID"}}).done(function(e){loadProjectsByUser(e)}).fail(showError)}function clearAttachments(){document.getElementById("inputFileToLoad").value="",$("#listFiles").html(""),$("#file-list").html("")}function showAttachments(e){$("#file-list").html(""),$("#file-list").append("<br><br><br> <table id='tbl-file' class='display' cellspacing='0' width='100%' > </table>");var a="<thead><tr> <th style='display:none;'>ID</th> <th>Nombre del Archivo</th> <th>Fecha</th> <th></th> <th></th> </tr></thead><tbody id='tableBody-file'>  </tbody>";$("#tbl-file").append(a);var t=JSON.parse(e);$.each(t,function(e,a){$("#tableBody-file").append(`\n            <tr class=datarow>\n                <td style='display:none;' > ${a.id} </td>\n                <td> ${a.name} </td>\n                <td>${moment(1e3*a.date).format("MMMM Do YYYY, h:mm")} </td>\n                <td> <a class="js-modal-confirm" id="update${a.id}" > <i class="glyphicon glyphicon-download-alt" aria-hidden="true"> </i> Descargar </a>\n                <td> <a class="js-modal-confirm" id="delete${a.id}"> <i class="glyphicon glyphicon-trash" aria-hidden="true"> </i> Eliminar </a>\n                <img id=update" + item.id +" class=download></td>\n            </tr>\n        `),$("#update"+a.id).click(DownloadEventHandler),$("#delete"+a.id).click(DeleteAttachmentEventHandler)})}function DeleteAttachmentEventHandler(){idFile=$(this).parents("tr").find("td").eq(0).text().trim(),$.ajax({type:"POST",url:"class/Task.php",data:{action:"DeleteAttachment",idFile:idFile}}).done(function(){swal({position:"top-end",type:"success",title:"Archivo Eliminado",showConfirmButton:!1,timer:750})}).fail(showError).always(function(){LoadAttachments()})}function DownloadEventHandler(){idFile=$(this).parents("tr").find("td").eq(0).text().trim(),idName=$(this).parents("tr").find("td").eq(1).text().trim(),$.ajax({type:"POST",url:"class/Task.php",data:{action:"DownloadTaskFile",idFile:idFile}}).done(function(e){decode_file(e,idName)}).fail(showError)}function LoadAttachments(){$.ajax({type:"POST",url:"class/Task.php",data:{action:"LoadTaskFiles",id:id}}).done(function(e){showAttachments(e)}).fail(showError)}function LoadSubTasksByTask(){$.ajax({type:"POST",url:"class/Task.php",data:{action:"LoadSubTasksByTask",id:id}}).done(function(e){showSubTasks(e)}).fail(showError)}function showSubTasks(e){$("#dataTable").empty();var a=JSON.parse(e);$.each(a,function(e,a){addRow("dataTable",a.title,a.position,a.status,a.id)})}function SaveTask(){if(!FormValidate())return!1;var e="NULL"==id?"Insert":"Update",a=new Object,t=$("#description").val();t=t.replace(/\n/g,"\n\r"),t=$.trim(t);var n=$("#title").val();if(n=$.trim(n),$("table#dataTable tr").each(function(e,a){console.log(a)}),varSubTask="0",$("table#dataTable tr").each(function(){var e=$(this).find("td"),t=e[2].firstElementChild.value,n=e[4].firstElementChild.value;varSubTask="1",t=$.trim(t),a=new Object,a.title=t,a.id=n,arraySubTask.push(a)}),arrayOffiles.length>0){for(var i=0;i<arrayOffiles.length;i++){var o=arrayOffiles[i][1],l=o.split(";"),s=(l[0].split(":")[1],l[1].split(",")[1]);arrayOffiles[i][1]=s}mifile="1"}else mifile="0";$("#btnSaveTask").attr("disabled","disabled"),$.ajax({type:"POST",url:"class/Task.php",data:{action:e,id:id,title:n,description:t,date_started:$("#date_started").val(),date_due:$("#date_due").val(),mifile:mifile,subtask_des:JSON.stringify(arraySubTask),subTask:varSubTask,objFile:JSON.stringify(arrayOffiles)}}).done(function(e){var a=JSON.parse(e);a.result?(swal({position:"top-end",type:"success",title:"Tarea enviada",showConfirmButton:!1,timer:750}),$("#title").val(""),$("#description").val(""),formatTableSubTask("dataTable"),clearAttachments(),$("#file-list").empty(),$("#cerrar-modal").click(),LoadColumns()):swal({position:"top-end",type:"error",title:"Ha ocurrido un error al crear la tarea.",showConfirmButton:!0,timer:3e3})}).fail(function(e){var a=JSON.parse(e.responseText);-666==a.code&&setTimeout(function(){let e;Swal.fire({title:"Sesión Expirada!",html:"Redireccionando en <strong></strong> segundos.",timer:3e3,onBeforeOpen:()=>{Swal.showLoading(),e=setInterval(()=>{Swal.getContent().querySelector("strong").textContent=Swal.getTimerLeft()},100)},onClose:()=>{clearInterval(e),location.href="Login.php"}}).then(e=>{location.href="Login.php"})},3e3)}).always(function(){setTimeout('$("#btnSaveTask").removeAttr("disabled")',750),CleanCtls(),clearAttachments()})}function addRow(e,a=null,t=null,n=null,i="new"){var o=document.getElementById(e),l=o.rows.length,s=o.insertRow(l),r=s.insertCell(0),d=document.createElement("input");d.type="checkbox",d.name="chkbox[]",r.appendChild(d);var c=s.insertCell(1);Count=l+1,c.innerHTML="<span style='color:#ddd;'>"+Count+"</span>";var u=s.insertCell(2),p=document.createElement("input");p.type="text",p.name="txtbox[]",p.className=" sub-task-desc",null!=a&&(p.value=a),u.appendChild(p);var m=s.insertCell(3);m.innerHTML+=`\n        <label class="label label-primary" > ${EstadoTarea(n)}  </label>\n    `;var f=s.insertCell(4);f.className="tdhide",f.innerHTML+=`\n        <input name="idSubTask" value="${i}" />\n    `}function deleteRow(e){try{for(var a=document.getElementById(e),t=a.rows.length,n=0;n<t;n++){var i=a.rows[n],o=i.cells[0].childNodes[0];null!=o&&1==o.checked&&(DeleteSubTask(a.rows[n].lastChild.childNodes[1].value),a.deleteRow(n),t--,n--)}}catch(e){alert(e)}}function formatTableSubTask(e){try{$("#subtask").val("");for(var a=document.getElementById(e),t=a.rows.length,n=0;n<t-1;n++)a.deleteRow(t-n-1)}catch(e){alert(e)}}function FormValidate(){if(""==$("#title").val())return $("#title").css("border","0.3px solid firebrick"),document.getElementById("title").placeholder="REQUERIDO",$("#title").focus(),!1;if($("#title").val().length<5)return $("#title").css("border","0.3px solid firebrick"),showError("Título: Mínimo 5 digitos sin guiones ni espacios"),!1;if(""!=$("#description").val()&&$("#description").val().length<5)return $("#description").css("border","0.3px solid firebrick"),showError("La descripción debe tener mínimo 5 caracteres"),!1;var e=$("#description").val();return CadenaSinEspacios=e.trim(),document.getElementById("description").value=CadenaSinEspacios,!0}function EstadoTarea(e=null){return null==e?"Pendiente":0==e?"Pendiente":1==e?"En Ejecución":2==e?"Completado":void 0}function DeleteSubTask(e){$.ajax({type:"POST",url:"class/Task.php",data:{action:"DeleteSubTask",idSubTask:e}}).done(function(){}).fail(function(e){showError(e)})}var id="NULL",mifile="0",arrayOfThisfile=[],arrayOffiles=[],arraySubTask=[];$(document).ready(function(){$("#logout").click(function(){$.ajax({type:"POST",url:"class/Sesion.php",data:{action:"logout"}}).done(function(){location.href="index.html"})}),this.Exit=function(){CleanCtls(),$(".modal").css({display:"none"})},$("#btnSearch").click(function(){$("#search").show()}),$("#search").on("keyup",function(e){var a=$("#buscar").val();$(".drag-inner-list > li").each(function(){var e=$(this)[0].className.toLowerCase(),t=-1!==e.indexOf(a.toLowerCase());$(this).toggle(t)}),113==e.keyCode&&LoadTaskByName()}),LoadColumns(),setInterval(function(){LoadColumns()},6e4),encode_Files(),$("#inputFileToLoad").change(function(){var e=document.getElementById("inputFileToLoad").files;if(e.length>0){var a=e[0],t=new FileReader;t.onload=function(e){var a=e.target.result;console.log(a),$("#response").val(a)},t.readAsDataURL(a)}}),$("#cerrar-modal").click(function(){CleanCtls(),clearAttachments()}),$("#btnSaveComment").click(function(){comment.taskId=id,comment.Save}),$(".modal-open").click(function(){alert("cerrar modal")})});