var id="NULL",mifile="0",arrayOfThisfile=[],arrayOffiles=[],arraySubTask=[];$(document).ready(function(){this.Exit=function(){CleanCtls(),$(".modal").css({display:"none"})},LoadColumns(),LoadProjects(),encode_Files(),$("#inputFileToLoad").change(function(){var a=document.getElementById("inputFileToLoad").files;if(0<a.length){var b=a[0],c=new FileReader;c.onload=function(d){var g=d.target.result;console.log(g),$("#response").val(g)},c.readAsDataURL(b)}}),$("#cerrar-modal").click(function(){CleanCtls()}),$("#btnSaveComment").click(function(){comment.taskId=id,comment.Save}),$(".modal-open").click(function(){alert("cerrar modal")})});function BtnCreateNew(){id="NULL",$("#row-comments").hide(),$("#ModalLabel").text("Ingresar Nueva Tarea");var a=new Date(Date()+"GMT-0000"),b=a.toISOString().slice(0,16);document.getElementById("date_started").value=b,document.getElementById("date_due").value="",CleanCtls(),clearAttachments()}function LoadColumns(){$.ajax({type:"POST",url:"class/Task.php",data:{action:"LoadColumns"}}).done(function(a){ShowColumn(a)})}function ShowColumn(a){$("#drag-list").html("");var b=JSON.parse(a),c="",d="";$.each(b,function(g,h){switch(h.position){case"1":c="drag-column-on-hold",d="<button type=\"button\" style=\"background-color: transparent; border: 0;\" id=\"btn-create-new-task\" onclick=\"BtnCreateNew()\" data-toggle=\"modal\" data-target=\".bd-example-modal-lg\"> <span class=\"fa fa-plus-circle\" aria-hidden=\"true\" </span></button>";break;case"2":c="drag-column-in-progress",d="";break;case"3":c="drag-column-needs-review",d="";break;case"4":c="drag-column-approved",d="";break;default:c="drag-column-on-hold",d="";}var j="<li class=\"drag-column "+c+"\"><span class=\"drag-column-header\"><h2 style=\"color: white; font-family: Lato; font-size: 1.3rem; margin: 0; text-transform: uppercase; font-weight: 150; line-height: 1.5; -webkit-font-smoothing: antialiased;\">"+h.title+"</h2>"+d+"</span><div class=\"drag-options\" id=\"options7\"></div><ul class=\"drag-inner-list\" id=\""+h.position+"\"></ul></li>";$("#drag-list").append(j)}),LoadTasks()}function LoadTasks(){$.ajax({type:"POST",url:"class/Task.php",data:{action:"LoadTask"}}).done(function(a){ShowTasks(a)})}function ShowTasks(a){var b=JSON.parse(a);$.each(b,function(c,d){var g=moment(1e3*d.date_creation).format(),h=g.slice(0,16).replace("T"," "),j="#"+d.position,k="<li onclick=\"open_task("+d.id+")\" onmouseover=\"taskMouseOver(this)\" onmouseout=\"taskMouseOut(this)\"><p>No: "+d.id+"<br>Fecha: "+h+"<br>Asunto: "+d.title+"<br></p></li>";$(j).append(k)})}function open_task(a){id=a,$.ajax({type:"POST",url:"class/Task.php",data:{action:"Load",id:a}}).done(function(b){ShowTaskData(b)}).fail(showError),$(".modal").modal("show")}function taskMouseOver(a){a.style.backgroundColor="#33363d",a.style.fontWeight="600",a.style.cursor="pointer"}function taskMouseOut(a){a.style.backgroundColor="#1e2026",a.style.fontWeight="400"}function encode_Files(){$("#inputFileToLoad").change(function(){arrayOffiles=[];var a=document.getElementById("inputFileToLoad").files;if(0<a.length)for(var b=0;b<document.getElementById("inputFileToLoad").files.length;b+=1)getBase64(a[b])})}function getBase64(a){arrayOfThisfile=[];var b=new FileReader;b.readAsDataURL(a),b.onload=function(c){arrayOfThisfile=[],$("dataExt",{src:c.target.result,title:a.name}),arrayOfThisfile.push(a.name),arrayOfThisfile.push(c.target.result),arrayOffiles.push(arrayOfThisfile)},b.onerror=function(c){console.log("Error: ",c)}}function decode_file(a){var b=a.split("\""),c=b[1];c=c.replace(/\\/g,"");window.atob(c)}function showInfo(){swal({position:"top-end",type:"success",title:"Good!",showConfirmButton:!1,timer:1500})}function showError(a){var b=JSON.parse(a.responseText);swal({type:"error",title:"Oops...",text:"Algo no est\xE1 bien ("+b.code+"): "+b.msg,footer:"<a href>Contacte a Soporte T\xE9cnico</a>"})}function Load(){$.ajax({type:"POST",url:"class/Task.php",data:{action:"LoadTasksByUser"}}).done(function(a){ShowData(a)}).fail(showError)}function ShowData(a){$("#task-tbody").html("");var b=JSON.parse(a);$.each(b,function(c,d){var g=new Date(1e3*d.date_creation),h=g.toISOString().slice(0,16).replace("T"," "),j="<tr><td align=\"center\"><a id=Update"+d.id+" class=\"btn btn-default\"><em class=\"fa fa-pencil\"></em></a><a id=Delete"+d.id+" class=\"btn btn-danger\"><em class=\"fa fa-trash\"></em></a></td><td class=\"hidden-xs\">"+d.id+"</td><td style=\"min-width: 17em; max-width: 17em;\">"+d.title+"</td><td style=\"min-width: 22em; max-width: 22em;\">"+d.description+"</td><td style=\"min-width: 6em; max-width: 7em;\">"+d.position+"</td><td style=\"min-width: 9em; max-width: 9em;\">"+h+"</td></tr>";$("#task-tbody").append(j)})}function UpdateEventHandler(){$(".modal").css({display:"block"}),id=$(this).parents("tr").find("td").eq(1).text(),$.ajax({type:"POST",url:"class/Task.php",data:{action:"Load",id:id}}).done(function(a){ShowTaskData(a)}).fail(showError)}function CleanCtls(){$("#title").val(""),$("#description").val(""),$("#project_id").val(""),$("#column_id").val(""),$("#owner_id").val(""),$("#newComment").val(""),arrayOffiles=[],arraySubTask=[],$("#dataTable").empty(),$("#dataTable").append(`
        <tr>
            <td> <input id="chk" type="checkbox" name="chk"/> </td>
            <td> <span style="color:#ddd;"> 1 </span> </td>
            <td> <input id="subtask" class="sub-task-desc" type="text"/> </td>
            <td> <label id="estado" name="estado" class="label label-primary"> Pendiente </label> </td>
            <td  style="visibility: hidden"> <input id="idSubTask" name="idSubTask" value="new"/> </td>
        </tr>
    `),$("#commentBox").html(""),id="NULL"}function ShowTaskData(a){clearAttachments(),$("#newComment").removeAttr("disabled"),$("#row-comments").show(),$("#ModalLabel").text("Modificar Tarea");var b=JSON.parse(a);if($("#title").val(b[0].title),$("#description").val(b[0].description),2<b[0].date_started.length)var c=moment(1e3*b[0].date_started).format(),d=c.slice(0,16);if(2<b[0].date_due.length)var g=moment(1e3*b[0].date_due).format(),h=g.slice(0,16);$("#project_id").val(b[0].project_id),$("#date_started").val(d),$("#date_due").val(h),LoadAttachments(),LoadSubTasksByTask(),comment.taskId=id,comment.LoadbyTask}function loadProjectsByUser(a){var b=JSON.parse(a);$.each(b,function(c,d){var g="<option value="+d.id+">"+d.name+"</option>";$(".list").append(g)})}function LoadProjects(){$.ajax({type:"POST",url:"class/Project.php",data:{action:"GetByUserID"}}).done(function(a){loadProjectsByUser(a)}).fail(showError)}function clearAttachments(){document.getElementById("inputFileToLoad").value="",$("#listFiles").html("")}function showAttachments(a){$("#file-list").html(""),$("#file-list").append("<br><br><br> <table id='tbl-file' class='display' cellspacing='0' width='100%' > </table>");$("#tbl-file").append("<thead><tr> <th style='display:none;'>ID</th> <th>Nombre del Archivo</th> <th>Fecha</th> <th></th> <th></th> </tr></thead><tbody id='tableBody-file'>  </tbody>");var c=JSON.parse(a);$.each(c,function(d,g){$("#tableBody-file").append(`
            <tr class=datarow>
                <td style='display:none;' > ${g.id} </td>
                <td> ${g.name} </td>
                <td>${moment(1e3*g.date).format("MMMM Do YYYY, h:mm")} </td>
                <td> <a class="js-modal-confirm" id="update${g.id}" > <i class="glyphicon glyphicon-download-alt" aria-hidden="true"> </i> Descargar </a>
                <td> <a class="js-modal-confirm" id="delete${g.id}"> <i class="glyphicon glyphicon-trash" aria-hidden="true"> </i> Eliminar </a>
                <img id=update" + item.id +" class=download></td>
            </tr>
        `),$("#update"+g.id).click(DownloadEventHandler),$("#delete"+g.id).click(DeleteAttachmentEventHandler)})}function DeleteAttachmentEventHandler(){idFile=$(this).parents("tr").find("td").eq(0).text(),$.ajax({type:"POST",url:"class/Task.php",data:{action:"DeleteAttachment",idFile:idFile}}).done(function(){swal({position:"top-end",type:"success",title:"Archivo Eliminado",showConfirmButton:!1,timer:1500})}).fail(showError).always(function(){LoadAttachments()})}function DownloadEventHandler(){idFile=$(this).parents("tr").find("td").eq(0).text(),$.ajax({type:"POST",url:"class/Task.php",data:{action:"DownloadTaskFile",idFile:idFile}}).done(function(a){decode_file(a)}).fail(showError)}function LoadAttachments(){$.ajax({type:"POST",url:"class/Task.php",data:{action:"LoadTaskFiles",id:id}}).done(function(a){showAttachments(a)}).fail(showError)}function LoadSubTasksByTask(){$.ajax({type:"POST",url:"class/Task.php",data:{action:"LoadSubTasksByTask",id:id}}).done(function(a){showSubTasks(a)}).fail(showError)}function showSubTasks(a){$("#dataTable").empty();var b=JSON.parse(a);$.each(b,function(c,d){addRow("dataTable",d.title,d.position,d.status,d.id)})}function SaveTask(){if(!FormValidate())return!1;var a="NULL"==id?"Insert":"Update",b={},c=$("#description").val();c=c.split("\t").join(" "),c=c.split("\n").join(" "),c=c.split("\"").join("'"),c=$.trim(c);var d=$("#title").val();if(d=d.split("\t").join(" "),d=d.split("\n").join(" "),d=d.split("\"").join("'"),d=$.trim(d),$("table#dataTable tr").each(function(m,n){console.log(n)}),varSubTask="0",$("table#dataTable tr").each(function(){var n=$(this).find("td"),o=n[2].firstElementChild.value,p=n[4].firstElementChild.value;varSubTask="1",o=o.split("\t").join(" "),o=o.split("\n").join(" "),o=o.split("\"").join("'"),o=$.trim(o),b={},b.title=o,b.id=p,arraySubTask.push(b)}),0<arrayOffiles.length){for(var g=0;g<arrayOffiles.length;g++){var h=arrayOffiles[g][1],j=h.split(";"),k=j[0].split(":")[1],l=j[1].split(",")[1];arrayOffiles[g][1]=l}mifile="1"}else mifile="0";$("#btnSaveTask").attr("disabled","disabled"),$.ajax({type:"POST",url:"class/Task.php",data:{action:a,id:id,title:d,description:c,projectid:$("#projectid").val(),date_started:$("#date_started").val(),date_due:$("#date_due").val(),mifile:mifile,subtask_des:JSON.stringify(arraySubTask),subTask:varSubTask,objFile:JSON.stringify(arrayOffiles)}}).done(function(){swal({position:"top-end",type:"success",title:"Tarea enviada",showConfirmButton:!1,timer:1500}),$("#title").val(""),$("#description").val(""),formatTableSubTask("dataTable"),clearAttachments(),$("#file-list").empty(),$("#cerrar-modal").click(),LoadColumns()}).fail(function(m){var n=JSON.parse(m);alert(n)}).always(function(){setTimeout("$(\"#btnSaveTask\").removeAttr(\"disabled\")",1500),CleanCtls()})}function addRow(a,b=null,c=null,d=null,g="new"){var h=document.getElementById(a),j=h.rows.length,k=h.insertRow(j),l=k.insertCell(0),m=document.createElement("input");m.type="checkbox",m.name="chkbox[]",l.appendChild(m);var n=k.insertCell(1);Count=j+1,n.innerHTML="<span style='color:#ddd;'>"+Count+"</span>";var o=k.insertCell(2),p=document.createElement("input");p.type="text",p.name="txtbox[]",p.className=" sub-task-desc",null!=b&&(p.value=b),o.appendChild(p);var q=k.insertCell(3);q.innerHTML+=`
        <label class="label label-primary" > ${EstadoTarea(d)}  </label>
    `;var r=k.insertCell(4);r.className="tdhide",r.innerHTML+=`
        <input name="idSubTask" value="${g}" />
    `}function deleteRow(a){try{for(var b=document.getElementById(a),c=b.rows.length,d=0;d<c;d++){var g=b.rows[d],h=g.cells[0].childNodes[0];null!=h&&!0==h.checked&&(DeleteSubTask(b.rows[d].lastChild.childNodes[1].value),b.deleteRow(d),c--,d--)}}catch(j){alert(j)}}function formatTableSubTask(a){try{$("#subtask").val("");for(var b=document.getElementById(a),c=b.rows.length,d=0;d<c-1;d++)b.deleteRow(c-d-1)}catch(g){alert(g)}}function FormValidate(){if(""==$("#title").val())return $("#title").css("border","0.3px solid firebrick"),document.getElementById("title").placeholder="REQUERIDO",$("#title").focus(),!1;if(5>$("#title").val().length)return $("#title").css("border","0.3px solid firebrick"),showError("T\xEDtulo: M\xEDnimo 5 digitos sin guiones ni espacios"),!1;if(""!=$("#description").val()&&5>$("#description").val().length)return $("#description").css("border","0.3px solid firebrick"),showError("La descripci\xF3n debe tener m\xEDnimo 5 caracteres"),!1;var a=$("#description").val();return CadenaSinEspacios=a.trim(),document.getElementById("description").value=CadenaSinEspacios,!0}function EstadoTarea(a=null){if(null==a)return"Pendiente";return 0==a?"Pendiente":1==a?"En Ejecuci\xF3n":2==a?"Completado":void 0}function DeleteSubTask(a){$.ajax({type:"POST",url:"class/Task.php",data:{action:"DeleteSubTask",idSubTask:a}}).done(function(){}).fail(function(b){showError(b)})}