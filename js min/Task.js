var id="NULL",mifile="0",arrayOfThisfile=[],arrayOffiles=[],arraySubTask=[];$(document).ready(function(){this.Exit=function(){CleanCtls(),$(".modal").css({display:"none"})},LoadColumns(),LoadProjects(),encode_Files(),$("#inputFileToLoad").change(function(){var t=document.getElementById("inputFileToLoad").files;if(t.length>0){var e=t[0],a=new FileReader;a.onload=function(t){var e=t.target.result;console.log(e),$("#response").val(e)},a.readAsDataURL(e)}}),$("#cerrar-modal").click(function(){CleanCtls()}),$("#btnSaveComment").click(function(){comment.taskId=id,comment.Save}),$(".modal-open").click(function(){alert("cerrar modal")})});function BtnCreateNew(){id="NULL",$("#row-comments").hide(),$("#ModalLabel").text("Ingresar Nueva Tarea");var t=new Date(Date()+"GMT-0000").toISOString().slice(0,16);document.getElementById("date_started").value=t,document.getElementById("date_due").value="",CleanCtls(),clearAttachments()}function LoadColumns(){$.ajax({type:"POST",url:"class/Task.php",data:{action:"LoadColumns"}}).done(function(t){ShowColumn(t)})}function ShowColumn(t){$("#drag-list").html("");var e=JSON.parse(t),a="",n="";$.each(e,function(t,e){switch(e.position){case"1":a="drag-column-on-hold",n='<button type="button" style="background-color: transparent; border: 0;" id="btn-create-new-task" onclick="BtnCreateNew()" data-toggle="modal" data-target=".bd-example-modal-lg"> <span class="fa fa-plus-circle" aria-hidden="true" </span></button>';break;case"2":a="drag-column-in-progress",n="";break;case"3":a="drag-column-needs-review",n="";break;case"4":a="drag-column-approved",n="";break;default:a="drag-column-on-hold",n=""}var i='<li class="drag-column '+a+'"><span class="drag-column-header"><h2 style="color: white; font-family: Lato; font-size: 1.3rem; margin: 0; text-transform: uppercase; font-weight: 150; line-height: 1.5; -webkit-font-smoothing: antialiased;">'+e.title+"</h2>"+n+'</span><div class="drag-options" id="options7"></div><ul class="drag-inner-list" id="'+e.position+'"></ul></li>';$("#drag-list").append(i)}),LoadTasks()}function LoadTasks(){$.ajax({type:"POST",url:"class/Task.php",data:{action:"LoadTask"}}).done(function(t){ShowTasks(t)})}function ShowTasks(t){var e=JSON.parse(t);$.each(e,function(t,e){var a=moment(1e3*e.date_creation).format().slice(0,16).replace("T"," "),n="#"+e.position,i='<li onclick="open_task('+e.id+')" onmouseover="taskMouseOver(this)" onmouseout="taskMouseOut(this)"><p>No: '+e.id+"<br>Fecha: "+a+"<br>Asunto: "+e.title+"<br></p></li>";$(n).append(i)})}function open_task(t){id=t,$.ajax({type:"POST",url:"class/Task.php",data:{action:"Load",id:t}}).done(function(t){ShowTaskData(t)}).fail(showError),$(".modal").modal("show")}function taskMouseOver(t){t.style.backgroundColor="#33363d",t.style.fontWeight="600",t.style.cursor="pointer"}function taskMouseOut(t){t.style.backgroundColor="#1e2026",t.style.fontWeight="400"}function encode_Files(){$("#inputFileToLoad").change(function(){arrayOffiles=[];var t=document.getElementById("inputFileToLoad").files;if(t.length>0)for(var e=0;e<document.getElementById("inputFileToLoad").files.length;e+=1)getBase64(t[e])})}function getBase64(t){arrayOfThisfile=[];var e=new FileReader;e.readAsDataURL(t),e.onload=function(e){arrayOfThisfile=[],$("dataExt",{src:e.target.result,title:t.name}),arrayOfThisfile.push(t.name),arrayOfThisfile.push(e.target.result),arrayOffiles.push(arrayOfThisfile)},e.onerror=function(t){console.log("Error: ",t)}}function decode_file(t){var e=t.split('"')[1];e=e.replace(/\\/g,"");window.atob(e)}function showInfo(){swal({position:"top-end",type:"success",title:"Good!",showConfirmButton:!1,timer:750})}function showError(t){var e=JSON.parse(t.responseText);swal({type:"error",title:"Oops...",text:"Algo no está bien ("+e.code+"): "+e.msg,footer:"<a href>Contacte a Soporte Técnico</a>"})}function Load(){$.ajax({type:"POST",url:"class/Task.php",data:{action:"LoadTasksByUser"}}).done(function(t){ShowData(t)}).fail(showError)}function ShowData(t){$("#task-tbody").html("");var e=JSON.parse(t);$.each(e,function(t,e){var a=new Date(1e3*e.date_creation).toISOString().slice(0,16).replace("T"," "),n='<tr><td align="center"><a id=Update'+e.id+' class="btn btn-default"><em class="fa fa-pencil"></em></a><a id=Delete'+e.id+' class="btn btn-danger"><em class="fa fa-trash"></em></a></td><td class="hidden-xs">'+e.id+'</td><td style="min-width: 17em; max-width: 17em;">'+e.title+'</td><td style="min-width: 22em; max-width: 22em;">'+e.description+'</td><td style="min-width: 6em; max-width: 7em;">'+e.position+'</td><td style="min-width: 9em; max-width: 9em;">'+a+"</td></tr>";$("#task-tbody").append(n)})}function UpdateEventHandler(){$(".modal").css({display:"block"}),id=$(this).parents("tr").find("td").eq(1).text(),$.ajax({type:"POST",url:"class/Task.php",data:{action:"Load",id:id}}).done(function(t){ShowTaskData(t)}).fail(showError)}function CleanCtls(){$("#title").val(""),$("#description").val(""),$("#project_id").val(""),$("#column_id").val(""),$("#owner_id").val(""),$("#newComment").val(""),arrayOffiles=[],arraySubTask=[],$("#dataTable").empty(),$("#dataTable").append('\n        <tr>\n            <td> <input id="chk" type="checkbox" name="chk"/> </td>\n            <td> <span style="color:#ddd;"> 1 </span> </td>\n            <td> <input id="subtask" class="sub-task-desc" type="text"/> </td>\n            <td> <label id="estado" name="estado" class="label label-primary"> Pendiente </label> </td>\n            <td  style="visibility: hidden"> <input id="idSubTask" name="idSubTask" value="new"/> </td>\n        </tr>\n    '),$("#commentBox").html(""),id="NULL"}function ShowTaskData(t){clearAttachments(),$("#newComment").removeAttr("disabled"),$("#row-comments").show(),$("#ModalLabel").text("Modificar Tarea");var e=JSON.parse(t);if($("#title").val(e[0].title),$("#description").val(e[0].description),e[0].date_started.length>2)var a=moment(1e3*e[0].date_started).format().slice(0,16);if(e[0].date_due.length>2)var n=moment(1e3*e[0].date_due).format().slice(0,16);$("#project_id").val(e[0].project_id),$("#date_started").val(a),$("#date_due").val(n),LoadAttachments(),LoadSubTasksByTask(),comment.taskId=id,comment.LoadbyTask}function loadProjectsByUser(t){var e=JSON.parse(t);$.each(e,function(t,e){var a="<option value="+e.id+">"+e.name+"</option>";$(".list").append(a)})}function LoadProjects(){$.ajax({type:"POST",url:"class/Project.php",data:{action:"GetByUserID"}}).done(function(t){loadProjectsByUser(t)}).fail(showError)}function clearAttachments(){document.getElementById("inputFileToLoad").value="",$("#listFiles").html("")}function showAttachments(t){$("#file-list").html(""),$("#file-list").append("<br><br><br> <table id='tbl-file' class='display' cellspacing='0' width='100%' > </table>");$("#tbl-file").append("<thead><tr> <th style='display:none;'>ID</th> <th>Nombre del Archivo</th> <th>Fecha</th> <th></th> <th></th> </tr></thead><tbody id='tableBody-file'>  </tbody>");var e=JSON.parse(t);$.each(e,function(t,e){$("#tableBody-file").append(`\n            <tr class=datarow>\n                <td style='display:none;' > ${e.id} </td>\n                <td> ${e.name} </td>\n                <td>${moment(1e3*e.date).format("MMMM Do YYYY, h:mm")} </td>\n                <td> <a class="js-modal-confirm" id="update${e.id}" > <i class="glyphicon glyphicon-download-alt" aria-hidden="true"> </i> Descargar </a>\n                <td> <a class="js-modal-confirm" id="delete${e.id}"> <i class="glyphicon glyphicon-trash" aria-hidden="true"> </i> Eliminar </a>\n                <img id=update" + item.id +" class=download></td>\n            </tr>\n        `),$("#update"+e.id).click(DownloadEventHandler),$("#delete"+e.id).click(DeleteAttachmentEventHandler)})}function DeleteAttachmentEventHandler(){idFile=$(this).parents("tr").find("td").eq(0).text(),$.ajax({type:"POST",url:"class/Task.php",data:{action:"DeleteAttachment",idFile:idFile}}).done(function(){swal({position:"top-end",type:"success",title:"Archivo Eliminado",showConfirmButton:!1,timer:750})}).fail(showError).always(function(){LoadAttachments()})}function DownloadEventHandler(){idFile=$(this).parents("tr").find("td").eq(0).text(),$.ajax({type:"POST",url:"class/Task.php",data:{action:"DownloadTaskFile",idFile:idFile}}).done(function(t){decode_file(t)}).fail(showError)}function LoadAttachments(){$.ajax({type:"POST",url:"class/Task.php",data:{action:"LoadTaskFiles",id:id}}).done(function(t){showAttachments(t)}).fail(showError)}function LoadSubTasksByTask(){$.ajax({type:"POST",url:"class/Task.php",data:{action:"LoadSubTasksByTask",id:id}}).done(function(t){showSubTasks(t)}).fail(showError)}function showSubTasks(t){$("#dataTable").empty();var e=JSON.parse(t);$.each(e,function(t,e){addRow("dataTable",e.title,e.position,e.status,e.id)})}function SaveTask(){if(!FormValidate())return!1;var t="NULL"==id?"Insert":"Update",e=new Object,a=$("#description").val();a=(a=(a=a.split("\t").join(" ")).split("\n").join(" ")).split('"').join("'"),a=$.trim(a);var n=$("#title").val();if(n=(n=(n=n.split("\t").join(" ")).split("\n").join(" ")).split('"').join("'"),n=$.trim(n),$("table#dataTable tr").each(function(t,e){console.log(e)}),varSubTask="0",$("table#dataTable tr").each(function(){var t=$(this).find("td"),a=t[2].firstElementChild.value,n=t[4].firstElementChild.value;varSubTask="1",a=(a=(a=a.split("\t").join(" ")).split("\n").join(" ")).split('"').join("'"),a=$.trim(a),(e=new Object).title=a,e.id=n,arraySubTask.push(e)}),arrayOffiles.length>0){for(var i=0;i<arrayOffiles.length;i++){var o=arrayOffiles[i][1].split(";"),l=(o[0].split(":")[1],o[1].split(",")[1]);arrayOffiles[i][1]=l}mifile="1"}else mifile="0";$("#btnSaveTask").attr("disabled","disabled"),$.ajax({type:"POST",url:"class/Task.php",data:{action:t,id:id,title:n,description:a,projectid:$("#projectid").val(),date_started:$("#date_started").val(),date_due:$("#date_due").val(),mifile:mifile,subtask_des:JSON.stringify(arraySubTask),subTask:varSubTask,objFile:JSON.stringify(arrayOffiles)}}).done(function(t){swal({position:"top-end",type:"success",title:"Tarea enviada",showConfirmButton:!1,timer:750}),$("#title").val(""),$("#description").val(""),formatTableSubTask("dataTable"),clearAttachments(),$("#file-list").empty(),$("#cerrar-modal").click(),LoadColumns()}).fail(function(t){var e=JSON.parse(t);alert(e)}).always(function(){setTimeout('$("#btnSaveTask").removeAttr("disabled")',750),CleanCtls()})}function addRow(t,e=null,a=null,n=null,i="new"){var o=document.getElementById(t),l=o.rows.length,s=o.insertRow(l),d=s.insertCell(0),r=document.createElement("input");r.type="checkbox",r.name="chkbox[]",d.appendChild(r);var c=s.insertCell(1);Count=l+1,c.innerHTML="<span style='color:#ddd;'>"+Count+"</span>";var u=s.insertCell(2),p=document.createElement("input");p.type="text",p.name="txtbox[]",p.className=" sub-task-desc",null!=e&&(p.value=e),u.appendChild(p);s.insertCell(3).innerHTML+=`\n        <label class="label label-primary" > ${EstadoTarea(n)}  </label>\n    `;var m=s.insertCell(4);m.className="tdhide",m.innerHTML+=`\n        <input name="idSubTask" value="${i}" />\n    `}function deleteRow(t){try{for(var e=document.getElementById(t),a=e.rows.length,n=0;n<a;n++){var i=e.rows[n].cells[0].childNodes[0];null!=i&&1==i.checked&&(DeleteSubTask(e.rows[n].lastChild.childNodes[1].value),e.deleteRow(n),a--,n--)}}catch(t){alert(t)}}function formatTableSubTask(t){try{$("#subtask").val("");for(var e=document.getElementById(t),a=e.rows.length,n=0;n<a-1;n++)e.deleteRow(a-n-1)}catch(t){alert(t)}}function FormValidate(){if(""==$("#title").val())return $("#title").css("border","0.3px solid firebrick"),document.getElementById("title").placeholder="REQUERIDO",$("#title").focus(),!1;if($("#title").val().length<5)return $("#title").css("border","0.3px solid firebrick"),showError("Título: Mínimo 5 digitos sin guiones ni espacios"),!1;if(""!=$("#description").val()&&$("#description").val().length<5)return $("#description").css("border","0.3px solid firebrick"),showError("La descripción debe tener mínimo 5 caracteres"),!1;var t=$("#description").val();return CadenaSinEspacios=t.trim(),document.getElementById("description").value=CadenaSinEspacios,!0}function EstadoTarea(t=null){return null==t?"Pendiente":0==t?"Pendiente":1==t?"En Ejecución":2==t?"Completado":void 0}function DeleteSubTask(t){$.ajax({type:"POST",url:"class/Task.php",data:{action:"DeleteSubTask",idSubTask:t}}).done(function(){}).fail(function(t){showError(t)})}